---
title: "Web Mapping in R"
subtitle: "using Leaflet"
author: "Bhaskar Karambelkar"
date: "2017/01/13"
output: slidy_presentation
---

```{r setup, include=FALSE}
```

```{r libs, echo=FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(widgetframe))
suppressPackageStartupMessages(library(leaflet))
suppressPackageStartupMessages(library(leaflet.extras))
```

background-image: url(http://leafletjs.com/docs/images/logo.png)

class: center, middle

<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
An open-source JavaScript library for interactive maps.

---

# Installation

Install the **leaflet** package from [Github](https://github.com/rstudio/leaflet)<sup>1</sup>:

```{r eval=FALSE, tidy=FALSE}
devtools::install_github("rstudio/leaflet")
```

- Is a `htmlwidget` which allows you to build dynamic interactive maps using the Javascript library.

- Based on version 0.7.x of the Leaflet Javascript library<sup>2</sup>.

- Other packages you will need:<br/> `sp`, `rgdal`, `rgeos`, `raster`, `rmapshaper`, `tigris`, `acs`, `sf`, `mapview`, `geojson`, `geojsonio`.

.footnote[
[1] The dev. version on Github is significantly ahead of the CRAN version in terms of features and bug-fixes. This version will be pushed to CRAN soon. 

[2] The latest version of LeafletJS is 1.x and the R package will be ported to 1.x eventually/soon.
]

---

# Map Components

- The `leaflet` map object (SVG).

- Tile Layers. <sup>1</sup>

- Vector Data Layers (points, lines, circles, rectangles, polygons).

- Raster Data Layers.

- Popups and labels.

- Controls (zoom control, layer control, buttons, attribution, legends).

- Custom controls and layers via lots and lots of  [plugins](http://www.leafletjs.com/plugins.html).

.footnote[
[1] [How web maps work](https://www.mapbox.com/help/how-web-maps-work/).
]

---

# Advanced Concepts

- Visualizations are organized into various panes. Different panes have different zIndex for overlay.

- Events are emitted for various actions and can be acted upon by registering event listeners for appropriate events.

- Data can be organized into groups which allows bulk operations on grouped data.

- Many 3rd-Party vendors (commercial and open-source) provide add-ons on top of Leaflet. e.g. ESRI, Mapbox, GIBs. 

---

class: inverse, center, middle

# BEGINNER

---

# Building a Map

```{r eg0, eval=FALSE}
leaflet(data) | leafletProxy() %>% 
  
  
  setView(lat, lon, zoom) # Initial View OR
  fitBounds(lat_se, lon_se, latnw, lon_nw) # Initial Bounds
  setMaxBounds(lat_se, lon_se, latnw, lon_nw) # Max Bounds
  
  addTiles() | addProviderTiles() | addWMSTiles() #Tiles
  
  addMarkers() | addCircleMarkers() |
    addAwesomeMarkers() | addLabelOnlyMarkers() # Markers
  
  addPolylines() | addCircles() |
  addRectangles() | addPolygons() # Shapes
  
  addRasterImage(image) # Raster Data
  
  addLegend() | addLayersControl() | addControl() # Controls
  
```

.footnote[
- A Map is built by piping (`%>%`) several add* methods.

- `leaflet()`/`addXXX()` methods take an optional `options` argument for customization.
]

---

# Minimal Example

```{r eg1.print, eval=FALSE}
library(leaflet)
leaflet()
```

```{r eg1, echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  frameWidget(height='275')
```

Wait, What? Where's my map?

---

# Tiles

```{r eg2.print, eval=FALSE}
leaflet() %>%
  addTiles()
```

```{r eg2, echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  addTiles() %>% setMapWidgetStyle() %>%
  frameWidget(height='275')
```

- Defaults to OpenStreetMap tiles. Custom URL can be provided via the `urlTemplate` param.
- `tileOptions()` can be used for customizing the tile layer.

---

# Provider Tiles

```{r eg3.print, eval=FALSE}
leaflet() %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group="Dark") %>%
  addProviderTiles(providers$CartoDB.Positron, group="Light") %>%
  addLayersControl(baseGroups=c('Dark','Light'))
```

```{r eg3, echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group="Dark") %>%
  addProviderTiles(providers$CartoDB.Positron, group="Light") %>%
  addLayersControl(baseGroups=c('Dark','Light')) %>%
  setMapWidgetStyle() %>%
  frameWidget(height='275')
```


There are more than 100 tile providers available via the `providers` list.

---

# Markers

- Represent unique locations on the map.

- Added using `addMarkers`, `addCircleMarkers`, `addAwesomeMarkers`, `addLabelOnlyMarkers`.

- Input can be vectors of lat/lon coordinates, data.frame, `sp::SpatialPoints`, `sp::SpatialPointsDataFrame`. 

- Can have labels, and popups whose content can be derived from the data.

- Can be toggled using grouping.

- Can be clustered for better performance and visual aesthetics.

---

# Adding Markers

```{r eg4, eval=FALSE}

leaflet(data) %>%
  
  addMarkers(
    lat = ~latitude, lon = ~longitude,
    
    options = markerOptions(),
  
    label=~label, labelOptions = labelOptions(),
    popup=~popup, popupOptions = popupOptions(),
    
    clusterOptions = clusterOptions(),
    
    group = 'Group-A')

  # Similarly 
  addCircleMarkers()  # Fixed scale Circles
  addAwesomeMarkers() # More choices for icons
  addLabelOnlyMarkers() # No icon
```

---

# Markers Example

```{r eg5.0, warning=FALSE}
quakes.df <- quakes %>% dplyr::mutate(
    mag.level = cut(mag,c(3.5,4.5,5.5,6.5),
    labels = c('> 3.5 & <=4.5', '>4.5 & <=5.5', '>5.5 & <=6.5'))) %>%
  split(.$mag.level)

l <- leaflet() %>%
  addProviderTiles(providers$Esri.OceanBasemap)

names(quakes.df) %>%
  purrr::walk( function(df) {
    l <<- l %>%
      addMarkers(data=quakes.df[[df]], lng=~long, lat=~lat,
                 label=~as.character(mag), popup=~as.character(mag),
                 group = df,
                 clusterOptions = markerClusterOptions())
  })

l <- l %>%
  addLayersControl(
    overlayGroups = names(quakes.df),
    options = layersControlOptions(collapsed = FALSE)) %>%
  addMiniMap(tiles = providers$Esri.OceanBasemap, width = 120, height=80)
```

---

# Markers Example

```{r eg5.1, echo=FALSE, message=FALSE, warning=FALSE}
l %>%
  frameWidget(height='440')
```

---

# Shapes

- Can be lines, circles, rectangles, polygons.

- Added using `addPolyLines`, `addCircles`, `addRectangles`, and `addPolygons`.

- For polylines: Input can be `sp::Lines`, `sp::SpatialLines`, `sp::SpatialLinesDataFrame`. 

- For polygons: Input can be `sp::Polygons`, `sp::SpatialPolygons`, `sp::SpatialPolygonsDataFrame`.

- Can have labels and popups whose content can be derived from data.

- Can have their appearance customized using data.

- Can be grouped for bulk operations.

- Can be highlighted on mouse-over.

---

# Adding Shapes

```{r eg6, eval=FALSE}

leaflet(data) %>%
  addPolygons(
    label=~label, labelOptions = labelOptions(),
    popup=~popup, popupOptions = popupOptions(),
             
    # Shape Options
    options = pathOptions(),
    weight = 1, opacity=0.8, color = "#000000",
    fillColor="#ff0000", fillOpacity=0.7,
             
    # Highlighting on mouse-over
    highlightOptions = highlightOptions(
      color='#00ff00', weight = 2,
      opacity = 1, fillOpacity = 1,
      bringToFront = TRUE, sendToBack = TRUE),
             
    group = 'Group-A')

  #Similarly
  addCircles()
  addPolylines()
  addRectangles()
```
